package g4rb4g3.at.abrptransmitter;

import com.google.gson.Gson;
import com.google.gson.GsonBuilder;
import com.google.gson.internal.bind.TypeAdapters;

import org.junit.Test;

import g4rb4g3.at.abrptransmitter.abrp.gson.DoubleTypeAdapter;
import g4rb4g3.at.abrptransmitter.abrp.gson.GsonRoutePlan;
import g4rb4g3.at.abrptransmitter.abrp.gson.Metadata;
import g4rb4g3.at.abrptransmitter.abrp.gson.Route;

import static org.junit.Assert.assertEquals;

public class GsonUnitTest {

    private String json = "{\"status\": \"ok\", \"metadata\": {\"plan_time\": 1.0441479682922363, \"plan_uuid\": \"550a4c1a-c275-4db2-a482-3b698688d784\"}, \"result\": {\"car_model\": \"hyundai:ioniq:17:28:other\", \"routes\": [{\"steps\": [{\"id\": 0, \"lat\": 49.2150784, \"lon\": 8.6401024, \"name\": \"\", \"region\": \"europe\", \"wp_type\": 2, \"max_speed\": 36.11111111111111, \"drive_dist\": 11574, \"is_charger\": false, \"is_station\": false, \"utc_offset\": 3600, \"is_waypoint\": true, \"arrival_dist\": 208358, \"arrival_perc\": 69, \"charger_type\": 0, \"is_mod_speed\": false, \"waypoint_idx\": 0, \"is_valid_step\": true, \"wait_duration\": 0, \"departure_dist\": 208358, \"departure_perc\": 69, \"drive_duration\": 995, \"is_destcharger\": false, \"is_end_station\": false, \"is_new_waypoint\": false, \"arrival_duration\": 12357, \"departure_duration\": 12357, \"is_amenity_charger\": false, \"path\": [[49.2173, 8.6372, 69, 0, 0, 12358, 208, \"\", 30, 108, 0, 0], [49.2145, 8.6019, 66.5, 197, 120, 11906, 203, \"\", 120, 115, 38, 0], [49.1713, 8.5741, 63.3, 160, 120, 11750, 198, \"\", 120, 116, 200, 0]]}, {\"id\": 3646837, \"lat\": 49.16125, \"lon\": 8.567226, \"name\": \"Bruchsal West [Ionity]\", \"region\": \"europe\", \"charger\": {\"id\": 3646837, \"lat\": 49.16125, \"lon\": 8.567226, \"url\": \"https://ionity.evapi.de/#/location/30\", \"name\": \"Bruchsal West [Ionity]\", \"region\": \"europe\", \"status\": \"OPEN\", \"address\": \"Baden-W\\u00fcrttemberg, Germany\", \"comment\": \"Number of CCS Chargers: 4\\nStation open 24/7\", \"outlets\": [{\"type\": \"ccs\", \"power\": 350, \"stalls\": 4, \"status\": null}], \"locationid\": \"ionity_30\", \"network_id\": 85, \"network_icon\": \"ionity.png\", \"network_name\": \"Ionity\"}, \"wp_type\": 0, \"max_speed\": 36.11111111111111, \"drive_dist\": 115733, \"is_charger\": true, \"is_station\": false, \"utc_offset\": 3600, \"charge_cost\": 8, \"is_waypoint\": false, \"arrival_dist\": 196784, \"arrival_perc\": 63, \"charger_type\": \"ccs\", \"is_mod_speed\": false, \"is_valid_step\": true, \"wait_duration\": 0, \"charge_profile\": [[63, 0], [66, 54], [70, 109], [73, 168], [77, 237], [81, 321], [84, 442], [88, 596], [91, 783], [92, 827]], \"departure_dist\": 196784, \"departure_perc\": 92, \"drive_duration\": 3683, \"is_destcharger\": false, \"is_end_station\": false, \"charge_duration\": 827, \"is_new_waypoint\": false, \"arrival_duration\": 11367, \"departure_duration\": 10539, \"is_amenity_charger\": false, \"charge_cost_currency\": \"\\u20ac\", \"path\": [[49.1612, 8.5673, 91.9, 0, 0, 10539, 197, \"\", null, 110, 0, 0], [49.1151, 8.5503, 88.8, 180, 130, 10301, 191, \"\", \"\\u221e\", 114, 221, 0], [49.0755, 8.5133, 85.2, 266, 130, 10157, 186, \"\", \"\\u221e\", 119, 245, 0], [49.0348, 8.4837, 81.8, 207, 130, 10018, 181, \"\", \"\\u221e\", 122, 224, 0], [48.9984, 8.4433, 78.5, 284, 120, 9875, 176, \"\", 120, 122, 200, 0], [48.9626, 8.4135, 75.5, 201, 120, 9723, 171, \"\", 120, 117, 50, 0], [48.9346, 8.3606, 72.1, 181, 130, 9569, 166, \"\", \"\\u221e\", 116, 200, 0], [48.8985, 8.3254, 68.6, 188, 130, 9427, 161, \"\", \"\\u221e\", 119, 286, 0], [48.8788, 8.2621, 65.1, 182, 130, 9284, 155, \"\", \"\\u221e\", 121, 207, 0], [48.8418, 8.2285, 61.9, 3, 0, 9151, 151, \"\", \"\\u221e\", 122, 0, 0], [48.8081, 8.1818, 58.5, 162, 120, 9005, 146, \"\", 120, 123, 77, 0], [48.77, 8.1412, 55.1, 280, 130, 8854, 140, \"\", \"\\u221e\", 128, 200, 0], [48.7298, 8.1069, 51.6, 195, 130, 8711, 135, \"\", \"\\u221e\", 126, 267, 0], [48.69, 8.0677, 48.1, 163, 130, 8564, 130, \"\", \"\\u221e\", 127, 310, 0], [48.6528, 8.0333, 44.7, 155, 130, 8429, 125, \"\", \"\\u221e\", 134, 89, 0], [48.6121, 8.0021, 41.2, 187, 130, 8287, 120, \"\", \"\\u221e\", 136, 78, 0], [48.5711, 7.9622, 37.4, 203, 130, 8136, 114, \"\", \"\\u221e\", 145, 247, 0], [48.5318, 7.931, 34.1, 176, 130, 7998, 109, \"\", \"\\u221e\", 142, 200, 0], [48.4924, 7.9018, 30.6, 123, 130, 7861, 104, \"\", \"\\u221e\", 149, 68, 0], [48.448, 7.9011, 27.4, 3, 0, 7720, 99, \"\", \"\\u221e\", 149, 0, 0], [48.4084, 7.8656, 23.9, 201, 130, 7577, 94, \"\", \"\\u221e\", 150, 86, 0], [48.3772, 7.8152, 20.4, 190, 130, 7436, 89, \"\", \"\\u221e\", 153, 53, 0], [48.3368, 7.7886, 16.8, 195, 130, 7295, 84, \"\", \"\\u221e\", 161, 52, 0]]}, {\"id\": 3646823, \"lat\": 48.309517, \"lon\": 7.788855, \"name\": \"Mahlberg West [Ionity]\", \"region\": \"europe\", \"charger\": {\"id\": 3646823, \"lat\": 48.309517, \"lon\": 7.788855, \"url\": \"https://ionity.evapi.de/#/location/25\", \"name\": \"Mahlberg West [Ionity]\", \"region\": \"europe\", \"status\": \"OPEN\", \"address\": \"Baden-W\\u00fcrttemberg, Germany\", \"comment\": \"Number of CCS Chargers: 4\\nStation open 24/7\", \"outlets\": [{\"type\": \"ccs\", \"power\": 350, \"stalls\": 4, \"status\": null}], \"locationid\": \"ionity_25\", \"network_id\": 85, \"network_icon\": \"ionity.png\", \"network_name\": \"Ionity\"}, \"wp_type\": 0, \"max_speed\": 36.11111111111111, \"drive_dist\": 52525, \"is_charger\": true, \"is_station\": false, \"utc_offset\": 3600, \"charge_cost\": 8, \"is_waypoint\": false, \"arrival_dist\": 81051, \"arrival_perc\": 15, \"charger_type\": \"ccs\", \"is_mod_speed\": false, \"is_valid_step\": true, \"wait_duration\": 0, \"charge_profile\": [[15, 0], [19, 61], [22, 120], [26, 179], [29, 237], [33, 294], [36, 351], [40, 408], [44, 465], [47, 521], [51, 577]], \"departure_dist\": 81051, \"departure_perc\": 51, \"drive_duration\": 2317, \"is_destcharger\": false, \"is_end_station\": false, \"charge_duration\": 577, \"is_new_waypoint\": false, \"arrival_duration\": 6875, \"departure_duration\": 6298, \"is_amenity_charger\": false, \"charge_cost_currency\": \"\\u20ac\", \"path\": [[48.3095, 7.7889, 50.7, 0, 0, 6298, 81, \"\", null, 162, 0, 0], [48.2656, 7.7711, 47.4, 212, 130, 6080, 76, \"\", \"\\u221e\", 164, 109, 0], [48.2221, 7.7479, 43.8, 214, 130, 5937, 71, \"\", \"\\u221e\", 169, 251, 0], [48.1771, 7.7494, 40.4, 222, 130, 5797, 66, \"\", \"\\u221e\", 172, 111, 0], [48.1349, 7.7766, 36.8, 185, 130, 5655, 61, \"\", \"\\u221e\", 182, 200, 0], [48.092, 7.7957, 33.3, 50, 130, 5517, 56, \"\", \"\\u221e\", 191, 7, 0], [48.0479, 7.8105, 29.4, 89, 130, 5373, 50, \"\", \"\\u221e\", 217, 71, 0], [48.0149, 7.7952, 26.2, 125, 100, 5167, 45, \"\", 100, 229, 74, 0], [47.9899, 7.848, 23.4, 127, 30, 4901, 40, \"\", 30, 275, 17, 0], [47.9788, 7.9133, 20.5, 126, 92, 4559, 35, \"\", 80, 326, 39, 0], [47.9691, 7.9784, 16.4, 245, 100, 4387, 30, \"\", 100, 411, 60, 0]]}, {\"id\": 3911351, \"lat\": 47.96192, \"lon\": 7.986997, \"name\": \"Rainhofscheune [EnBW]\", \"region\": \"europe\", \"charger\": {\"id\": 3911351, \"lat\": 47.96192, \"lon\": 7.986997, \"url\": \"https://www.goingelectric.de/stromtankstellen/Deutschland/Kirchzarten/Rainhofscheune-Hoellentalstrasse-96/41541/\", \"name\": \"Rainhofscheune [EnBW]\", \"region\": \"europe\", \"status\": \"OPEN\", \"address\": \"H\\u00f6llentalstra\\u00dfe 96, Kirchzarten, Deutschland\", \"comment\": null, \"outlets\": [{\"type\": \"ccs\", \"power\": 50, \"stalls\": 1, \"status\": null}, {\"type\": \"chademo\", \"power\": 50, \"stalls\": 1, \"status\": null}, {\"type\": \"type2\", \"power\": 22, \"stalls\": 1, \"status\": null}], \"locationid\": \"ge_41541\", \"network_id\": 165, \"network_icon\": null, \"network_name\": \"EnBW\"}, \"wp_type\": 0, \"max_speed\": 36.11111111111111, \"drive_dist\": 28525, \"is_charger\": true, \"is_station\": false, \"utc_offset\": 3600, \"charge_cost\": 0, \"is_waypoint\": true, \"arrival_dist\": 28525, \"arrival_perc\": 15, \"charger_type\": \"ccs\", \"is_mod_speed\": false, \"waypoint_idx\": 1, \"is_valid_step\": true, \"wait_duration\": 0, \"charge_profile\": [[15, 0], [19, 99], [22, 197], [26, 294], [29, 391], [33, 486], [36, 580], [40, 675], [44, 768], [47, 861], [51, 953], [54, 1044], [58, 1135], [61, 1225], [65, 1315], [69, 1403], [72, 1491], [76, 1578], [79, 1664], [83, 1778], [86, 1917], [90, 2082], [94, 2310], [94, 2337]], \"departure_dist\": 28525, \"departure_perc\": 94, \"drive_duration\": 1616, \"is_destcharger\": false, \"is_end_station\": false, \"charge_duration\": 2337, \"is_new_waypoint\": false, \"arrival_duration\": 3994, \"departure_duration\": 1656, \"is_amenity_charger\": false, \"charge_cost_currency\": \"\", \"path\": [[47.9619, 7.987, 94, 0, 0, 1656, 29, \"\", null, 440, 0, 0], [47.9324, 8.0314, 90.2, -1, 80, 1267, 23, \"\", 100, 578, 20, 0], [47.9135, 8.0792, 85.2, 1, 0, 1021, 18, \"\", 50, 759, 0, 0], [47.9056, 8.1249, 80.9, 206, 100, 618, 13, \"\", 100, 904, 41, 0], [47.8961, 8.1578, 78.7, 348, 100, 411, 8, \"\", 100, 867, 45, 0], [47.8737, 8.1058, 73.9, 88, 60, 171, 3, \"\", 100, 997, 68, 0]]}, {\"id\": 2751993, \"lat\": 47.857, \"lon\": 8.11016, \"name\": \"Feldberg (Schwarzwald), Breisgau-Hochschwarzwald, Baden-Wurttemberg, Germany\", \"region\": \"europe\", \"wp_type\": 0, \"max_speed\": 36.11111111111111, \"is_charger\": false, \"is_station\": false, \"utc_offset\": 3600, \"is_waypoint\": true, \"arrival_dist\": 0, \"arrival_perc\": 72, \"charger_type\": 0, \"is_mod_speed\": false, \"is_valid_step\": true, \"departure_dist\": 0, \"departure_perc\": 72, \"is_destcharger\": false, \"is_end_station\": false, \"is_new_waypoint\": false, \"arrival_duration\": 0, \"departure_duration\": 0, \"is_amenity_charger\": false}], \"total_dist\": 208358, \"average_consumption\": 189.01595482512104, \"total_drive_duration\": 8611, \"total_charge_duration\": 3741}], \"path_indices\": {\"lat\": 0, \"lon\": 1, \"soc_perc\": 2, \"cons_per_km\": 3, \"speed\": 4, \"remaining_time\": 5, \"remaining_dist\": 6, \"instruction\": 7, \"speed_limit\": 8, \"elevation\": 9, \"path_distance\": 10}}}";

    @Test
    public void testGsonBuilder() {
        GsonBuilder builder = new GsonBuilder();
        builder.registerTypeAdapterFactory(TypeAdapters.newFactory(double.class, Double.class, new DoubleTypeAdapter()));
        Gson gson = builder.create();

        GsonRoutePlan routePlan = gson.fromJson(json, GsonRoutePlan.class);
        assertEquals(routePlan.getStatus(), "ok");

        Metadata metaData = routePlan.getMetadata();
        assertEquals(metaData.getPlanTime(), 1.0441479682922363d, 0.00001d);
        assertEquals(metaData.getPlanUuid(), "550a4c1a-c275-4db2-a482-3b698688d784");

        Route route = routePlan.getResult().getRoutes().get(0);
        assertEquals(route.getSteps().size(), 5);
    }
}
